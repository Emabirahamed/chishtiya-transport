<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü - Management System</title>
    
    <!-- Firebase v10 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC2BMeBAU-7tLrBw0dKehAVix6mT9C4lWI",
            authDomain: "chishtiya-transport.firebaseapp.com",
            databaseURL: "https://chishtiya-transport-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chishtiya-transport",
            storageBucket: "chishtiya-transport.firebasestorage.app",
            messagingSenderId: "796543197916",
            appId: "1:796543197916:web:64a0e89d68280986a60a19"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.auth = auth;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.authSignIn = signInWithEmailAndPassword;
        window.authCreateUser = createUserWithEmailAndPassword;
        window.authOnStateChanged = onAuthStateChanged;
        window.authSignOut = signOut;
        window.firebaseReady = true;
        
        console.log('‚úÖ Firebase initialized!');
    </script>
    
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Bengali', 'SolaimanLipi', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .dot.online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Auth Screens */
        .auth-container {
            max-width: 450px;
            margin: 80px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }
        
        .auth-container.active {
            display: block;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h1 {
            color: #2a5298;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
            width: auto;
        }
        
        .error-message {
            background: #f8d7da;
            color: #842029;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Main App */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }
        
        .app-container.active {
            display: block;
        }
        
        .app-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-title h1 {
            color: #2a5298;
            font-size: 1.8em;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 25px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            transition: all 0.3s;
            color: #6c757d;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .content-card h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.6em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-label {
            font-size: 0.95em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-pending { background: #ffc107; color: #000; }
        .badge-loaded { background: #17a2b8; color: white; }
        .badge-unloaded { background: #6f42c1; color: white; }
        .badge-delivered { background: #28a745; color: white; }
        .badge-paid { background: #28a745; color: white; }
        .badge-unpaid { background: #dc3545; color: white; }
        .badge-admin { background: #dc3545; color: white; }
        .badge-manager { background: #17a2b8; color: white; }
        .badge-scanner { background: #6c757d; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #2a5298;
            font-size: 1.5em;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }
        
        .qr-container {
            text-align: center;
            padding: 20px;
        }
        
        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        #reader {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }

        /* Vehicle Management Styles */
        .vehicle-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .vehicle-card:hover {
            border-color: #2a5298;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .vehicle-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #2a5298;
        }
        
        .parcel-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .vehicle-destination {
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .history-timeline {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-left: 4px solid #2a5298;
            border-radius: 5px;
        }
        
        .history-time {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .history-action {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .history-details {
            font-size: 0.95em;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                overflow-x: auto;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9em;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="status">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
    </div>

    <!-- Login Screen -->
    <div class="auth-container active" id="loginScreen">
        <div class="auth-header">
            <h1>üöõ ‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
            <p>Management System</p>
        </div>
        <div class="error-message" id="loginError"></div>
        <div class="form-group">
            <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
            <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
            <label>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-primary" onclick="login()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Main App -->
    <div class="app-container" id="mainApp">
        <div class="app-header">
            <div class="app-title">
                <h1>üöõ ‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
            </div>
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <span class="badge" id="userRole"></span>
                <button class="btn btn-danger btn-sm" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
            <button class="nav-tab" onclick="switchTab('addParcel')">‚ûï ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó</button>
            <button class="nav-tab" onclick="switchTab('manageParcel')">üì¶ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
            <button class="nav-tab" onclick="switchTab('scanParcel')">üì∑ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®</button>
            <button class="nav-tab" onclick="switchTab('vehicleManagement')">üöõ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
            <button class="nav-tab" onclick="switchTab('reports')">üìÑ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
            <button class="nav-tab admin-only" onclick="switchTab('users')">üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</div>
                    <div class="stat-value" id="totalParcels">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</div>
                    <div class="stat-value" id="deliveredParcels">0</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</div>
                    <div class="stat-value" id="pendingParcels">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                    <div class="stat-value" id="totalRevenue">‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                </div>
            </div>
            
            <div class="content-card">
                <h2>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü</h2>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Add Parcel Tab -->
        <div class="tab-content" id="addParcel">
            <div class="content-card">
                <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <form onsubmit="addParcel(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
                            <input type="text" id="senderName" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® *</label>
                            <input type="tel" id="senderPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
                            <input type="text" id="receiverName" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® *</label>
                            <input type="tel" id="receiverPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø *</label>
                            <input type="text" id="destination" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)</label>
                            <input type="number" id="weight" step="0.1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú *</label>
                            <input type="number" id="deliveryCharge" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ *</label>
                            <select id="paymentStatus" required>
                                <option value="unpaid">‡¶¨‡¶æ‡¶ï‡¶ø</option>
                                <option value="paid">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </form>
            </div>
        </div>

        <!-- Manage Parcel Tab -->
        <div class="tab-content" id="manageParcel">
            <div class="content-card">
                <h2>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                <div class="form-group">
                    <input type="text" id="searchParcel" placeholder="‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø, ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." 
                           oninput="filterParcels()">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</th>
                                <th>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                                <th>‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
                                <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="parcelsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Scan Parcel Tab -->
        <div class="tab-content" id="scanParcel">
            <div class="content-card">
                <h2>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <div id="reader"></div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startScanner()">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button class="btn btn-danger" onclick="stopScanner()" style="margin-left: 10px;">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                
                <div id="scanResult" style="margin-top: 30px; display: none;">
                    <h3>‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</h3>
                    <div id="scanResultContent"></div>
                    
                    <div style="margin-top: 20px;">
                        <h3>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</label>
                                <select id="scanStatus">
                                    <option value="loaded">‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶§‡ßã‡¶≤‡¶æ</option>
                                    <option value="unloaded">‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã</option>
                                    <option value="delivered">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶Ø‡¶¶‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º)</label>
                                <input type="text" id="scanVehicleNo" placeholder="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ó-‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</label>
                            <input type="text" id="scanLocation" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏, ‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ">
                        </div>
                        <button class="btn btn-success" onclick="updateScannedParcel()">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Management Tab -->
        <div class="tab-content" id="vehicleManagement">
            <div class="content-card">
                <h2>üöõ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </p>
                
                <div id="vehiclesList"></div>
                
                <div id="noVehicles" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
                    <p style="font-size: 1.2em;">üì≠ ‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
                    <p>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports">
            <div class="content-card">
                <h2>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateReport()">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                
                <div id="reportButtons" style="margin-top: 20px; display: none;">
                    <button class="btn btn-success" onclick="downloadReportPDF()">üì• PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                </div>
                
                <div id="reportResult"></div>
            </div>
        </div>

        <!-- Users Tab (Admin Only) -->
        <div class="tab-content admin-only" id="users">
            <div class="content-card">
                <h2>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button class="btn btn-primary" onclick="showAddUserForm()" style="margin-bottom: 20px;">
                    ‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                
                <div id="addUserForm" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>UID (Firebase Auth)</label>
                            <input type="text" id="newUserUid" placeholder="Firebase UID">
                        </div>
                        <div class="form-group">
                            <label>‡¶®‡¶æ‡¶Æ</label>
                            <input type="text" id="newUserName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                            <input type="email" id="newUserEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>‡¶∞‡ßã‡¶≤</label>
                            <select id="newUserRole">
                                <option value="scanner">Scanner</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addUser()">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <button class="btn btn-danger" onclick="hideAddUserForm()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                                <th>‡¶∞‡ßã‡¶≤</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- View Parcel Modal -->
    <div class="modal" id="viewParcelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <button class="close-btn" onclick="closeViewModal()">‚úï</button>
            </div>
            <div id="viewParcelContent"></div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ QR ‡¶ï‡ßã‡¶°</h3>
                <button class="close-btn" onclick="closeQRModal()">‚úï</button>
            </div>
            <div class="qr-container">
                <div id="qrcode" class="qr-code"></div>
                <p style="margin-top: 15px; color: #6c757d;">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                <button class="btn btn-primary" onclick="downloadQR()" style="margin-top: 15px;">
                    üì• QR ‡¶ï‡ßã‡¶° ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                </button>
            </div>
        </div>
    </div>

    <!-- Vehicle Details Modal -->
    <div class="modal" id="vehicleModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="vehicleModalTitle">üöõ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <button class="close-btn" onclick="closeVehicleModal()">‚úï</button>
            </div>
            <div id="vehicleModalContent"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let parcels = [];
        let currentReportData = null;
        let html5QrCode = null;
        let currentScannedParcelKey = null;
        let statusChart = null;

        function waitForFirebase(callback) {
            if (window.firebaseReady) callback();
            else setTimeout(() => waitForFirebase(callback), 100);
        }

        // Update connection status
        waitForFirebase(() => {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            statusDot.classList.add('online');
            statusText.textContent = '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®';
        });

        // Auth state observer
        waitForFirebase(() => {
            window.authOnStateChanged(window.auth, async (user) => {
                if (user) {
                    const userSnapshot = await window.dbGet(window.dbRef(window.db, 'users/' + user.uid));
                    if (userSnapshot.exists()) {
                        currentUser = { uid: user.uid, ...userSnapshot.val() };
                        showApp();
                    } else {
                        alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø');
                        logout();
                    }
                } else {
                    showLogin();
                }
            });
        });

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
                errorDiv.style.display = 'block';
                return;
            }
            
            window.authSignIn(window.auth, email, password)
                .catch(error => {
                    console.error('Login error:', error);
                    errorDiv.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§';
                    errorDiv.style.display = 'block';
                });
        }

        function logout() {
            window.authSignOut(window.auth);
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
            document.getElementById('userRole').className = 'badge badge-' + currentUser.role;
            
            // Hide admin-only elements for non-admins
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            });
            
            loadParcels();
            loadUsers();
            updateDashboard();
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®',
                'manager': '‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞',
                'scanner': '‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞'
            };
            return roles[role] || role;
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load specific tab data
            if (tabName === 'vehicleManagement') {
                loadVehicles();
            }
        }

        // Load parcels from Firebase
        function loadParcels() {
            const parcelsRef = window.dbRef(window.db, 'parcels');
            window.dbOnValue(parcelsRef, (snapshot) => {
                parcels = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        parcels.push({ key: child.key, ...child.val() });
                    });
                }
                displayParcels();
                updateDashboard();
            });
        }

        // Display parcels in table
        function displayParcels() {
            const tbody = document.getElementById('parcelsTableBody');
            tbody.innerHTML = '';
            
            const filteredParcels = filterParcelsArray();
            
            if (filteredParcels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á</td></tr>';
                return;
            }
            
            filteredParcels.forEach(parcel => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${parcel.id}</strong></td>
                    <td>${parcel.senderName}<br><small>${parcel.senderPhone}</small></td>
                    <td>${parcel.receiverName}<br><small>${parcel.receiverPhone}</small></td>
                    <td>${parcel.destination}</td>
                    <td>${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                    <td><span class="badge badge-${parcel.status}">${getStatusText(parcel.status)}</span></td>
                    <td>${parcel.date}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewParcel('${parcel.key}')">üëÅÔ∏è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                            <button class="btn btn-primary btn-sm" onclick="showQRCode('${parcel.id}')">QR</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteParcel('${parcel.key}', '${parcel.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        function filterParcels() {
            displayParcels();
        }

        function filterParcelsArray() {
            const searchTerm = document.getElementById('searchParcel')?.value.toLowerCase() || '';
            if (!searchTerm) return parcels;
            
            return parcels.filter(p => 
                p.id.toLowerCase().includes(searchTerm) ||
                p.senderName.toLowerCase().includes(searchTerm) ||
                p.receiverName.toLowerCase().includes(searchTerm) ||
                p.senderPhone.includes(searchTerm) ||
                p.receiverPhone.includes(searchTerm)
            );
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç',
                'loaded': '‡¶≤‡ßã‡¶°',
                'unloaded': '‡¶Ü‡¶®‡¶≤‡ßã‡¶°',
                'delivered': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°'
            };
            return statusMap[status] || status;
        }

        // Add new parcel
        async function addParcel(event) {
            event.preventDefault();
            
            const parcelData = {
                senderName: document.getElementById('senderName').value.trim(),
                senderPhone: document.getElementById('senderPhone').value.trim(),
                receiverName: document.getElementById('receiverName').value.trim(),
                receiverPhone: document.getElementById('receiverPhone').value.trim(),
                destination: document.getElementById('destination').value.trim(),
                weight: document.getElementById('weight').value || '',
                deliveryCharge: document.getElementById('deliveryCharge').value,
                paymentStatus: document.getElementById('paymentStatus').value,
                description: document.getElementById('description').value.trim(),
                status: 'pending',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('bn-BD'),
                createdBy: currentUser.name,
                currentLocation: '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏'
            };
            
            try {
                // Get current counter
                const counterRef = window.dbRef(window.db, 'counter');
                const counterSnapshot = await window.dbGet(counterRef);
                const currentCounter = counterSnapshot.exists() ? counterSnapshot.val() : 0;
                const newCounter = currentCounter + 1;
                
                // Generate ID
                const parcelId = 'CT' + String(newCounter).padStart(6, '0');
                parcelData.id = parcelId;
                
                // Add tracking history
                parcelData.tracking = [{
                    type: 'created',
                    description: '‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
                    location: '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏',
                    time: new Date().toLocaleString('bn-BD'),
                    by: currentUser.name
                }];
                
                // Save parcel
                const newParcelRef = window.dbPush(window.dbRef(window.db, 'parcels'));
                await window.dbSet(newParcelRef, parcelData);
                
                // Update counter
                await window.dbSet(counterRef, newCounter);
                
                alert('‚úÖ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + parcelId);
                
                // Reset form
                event.target.reset();
                
                // Switch to manage tab
                switchTab('manageParcel');
                document.querySelector('.nav-tab:nth-child(3)').click();
                
            } catch (error) {
                console.error('Error adding parcel:', error);
                alert('‚ùå ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        // View parcel details
        function viewParcel(key) {
            const parcel = parcels.find(p => p.key === key);
            if (!parcel) return;
            
            let historyHtml = '';
            if (parcel.tracking && parcel.tracking.length > 0) {
                historyHtml = '<div class="history-timeline"><h4>üìç ‡¶Æ‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4>';
                parcel.tracking.slice().reverse().forEach(track => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-time">‚è∞ ${track.time}</div>
                            <div class="history-action">${track.description}</div>
                            ${track.location ? `<div class="history-details">üìç ${track.location}</div>` : ''}
                            ${track.vehicleNo ? `<div class="history-details">üöõ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø: ${track.vehicleNo}</div>` : ''}
                            ${track.by ? `<div class="history-details">üë§ ${track.by}</div>` : ''}
                        </div>
                    `;
                });
                historyHtml += '</div>';
            }
            
            const html = `
                <div style="line-height: 1.8;">
                    <p><strong>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø:</strong> ${parcel.id}</p>
                    <p><strong>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï:</strong> ${parcel.senderName} (${parcel.senderPhone})</p>
                    <p><strong>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï:</strong> ${parcel.receiverName} (${parcel.receiverPhone})</p>
                    <p><strong>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</strong> ${parcel.destination}</p>
                    ${parcel.weight ? `<p><strong>‡¶ì‡¶ú‡¶®:</strong> ${parcel.weight} ‡¶ï‡ßá‡¶ú‡¶ø</p>` : ''}
                    <p><strong>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú:</strong> ${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <p><strong>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</strong> <span class="badge badge-${parcel.paymentStatus}">${parcel.paymentStatus === 'paid' ? '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§' : '‡¶¨‡¶æ‡¶ï‡¶ø'}</span></p>
                    <p><strong>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</strong> <span class="badge badge-${parcel.status}">${getStatusText(parcel.status)}</span></p>
                    <p><strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®:</strong> ${parcel.currentLocation || '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏'}</p>
                    ${parcel.currentVehicle ? `<p><strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ó‡¶æ‡¶°‡¶º‡¶ø:</strong> ${parcel.currentVehicle}</p>` : ''}
                    <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${parcel.date}</p>
                    <p><strong>‡¶∏‡¶Æ‡¶Ø‡¶º:</strong> ${parcel.time || 'N/A'}</p>
                    ${parcel.description ? `<p><strong>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</strong> ${parcel.description}</p>` : ''}
                    ${parcel.createdBy ? `<p><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> ${parcel.createdBy}</p>` : ''}
                </div>
                ${historyHtml}
            `;
            
            document.getElementById('viewParcelContent').innerHTML = html;
            document.getElementById('viewParcelModal').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewParcelModal').classList.remove('active');
        }

        // Show QR Code
        function showQRCode(parcelId) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            new QRCode(qrDiv, {
                text: parcelId,
                width: 256,
                height: 256,
                colorDark: "#2a5298",
                colorLight: "#ffffff",
            });
            
            document.getElementById('qrModal').classList.add('active');
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('active');
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'parcel-qr.png';
            link.href = url;
            link.click();
        }

        // Delete parcel
        async function deleteParcel(key, id) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á');
                return;
            }
            
            if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ${id} ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                try {
                    await window.dbRemove(window.dbRef(window.db, 'parcels/' + key));
                    alert('‚úÖ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                } catch (error) {
                    console.error('Error deleting parcel:', error);
                    alert('‚ùå ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                }
            }
        }

        // Scanner functions
        function startScanner() {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error('Error starting scanner:', err);
                alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                });
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            
            const parcel = parcels.find(p => p.id === decodedText);
            if (parcel) {
                currentScannedParcelKey = parcel.key;
                
                document.getElementById('scanResultContent').innerHTML = `
                    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤: ${parcel.id}</h4>
                        <p><strong>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï:</strong> ${parcel.senderName}</p>
                        <p><strong>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï:</strong> ${parcel.receiverName}</p>
                        <p><strong>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</strong> ${parcel.destination}</p>
                        <p><strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</strong> <span class="badge badge-${parcel.status}">${getStatusText(parcel.status)}</span></p>
                    </div>
                `;
                
                document.getElementById('scanResult').style.display = 'block';
                document.getElementById('scanLocation').value = parcel.currentLocation || '';
                document.getElementById('scanVehicleNo').value = parcel.currentVehicle || '';
            } else {
                alert('‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø: ' + decodedText);
            }
        }

        function onScanError(error) {
            // Ignore scan errors
        }

        // Update scanned parcel
        async function updateScannedParcel() {
            if (!currentScannedParcelKey) return;
            
            const status = document.getElementById('scanStatus').value;
            const vehicleNo = document.getElementById('scanVehicleNo').value.trim();
            const location = document.getElementById('scanLocation').value.trim();
            
            const parcel = parcels.find(p => p.key === currentScannedParcelKey);
            if (!parcel) return;
            
            const updates = {
                status: status,
                currentLocation: location || parcel.currentLocation
            };
            
            // Create tracking entry
            const trackingEntry = {
                type: status,
                time: new Date().toLocaleString('bn-BD'),
                by: currentUser.name,
                location: location
            };
            
            if (status === 'loaded' && vehicleNo) {
                updates.currentVehicle = vehicleNo;
                trackingEntry.description = `‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (${vehicleNo})`;
                trackingEntry.vehicleNo = vehicleNo;
            } else if (status === 'unloaded') {
                trackingEntry.description = `‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø‡ßá ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`;
                if (parcel.currentVehicle) {
                    trackingEntry.vehicleNo = parcel.currentVehicle;
                }
                updates.currentVehicle = null;
            } else if (status === 'delivered') {
                trackingEntry.description = '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
                updates.currentVehicle = null;
            }
            
            // Add to tracking history
            const tracking = parcel.tracking || [];
            tracking.push(trackingEntry);
            updates.tracking = tracking;
            
            try {
                await window.dbUpdate(window.dbRef(window.db, 'parcels/' + currentScannedParcelKey), updates);
                alert('‚úÖ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                
                // Reset
                document.getElementById('scanResult').style.display = 'none';
                currentScannedParcelKey = null;
                document.getElementById('scanVehicleNo').value = '';
                document.getElementById('scanLocation').value = '';
            } catch (error) {
                console.error('Error updating parcel:', error);
                alert('‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        // Vehicle Management Functions
        function loadVehicles() {
            const vehicleMap = new Map();
            
            // Group parcels by vehicle
            parcels.forEach(parcel => {
                if (parcel.currentVehicle && (parcel.status === 'loaded' || parcel.status === 'unloaded')) {
                    if (!vehicleMap.has(parcel.currentVehicle)) {
                        vehicleMap.set(parcel.currentVehicle, {
                            vehicleNo: parcel.currentVehicle,
                            parcels: [],
                            destinations: new Set()
                        });
                    }
                    const vehicle = vehicleMap.get(parcel.currentVehicle);
                    vehicle.parcels.push(parcel);
                    vehicle.destinations.add(parcel.destination);
                }
            });
            
            const vehiclesList = document.getElementById('vehiclesList');
            const noVehicles = document.getElementById('noVehicles');
            
            if (vehicleMap.size === 0) {
                vehiclesList.innerHTML = '';
                noVehicles.style.display = 'block';
                return;
            }
            
            noVehicles.style.display = 'none';
            let html = '';
            
            vehicleMap.forEach((vehicle, vehicleNo) => {
                const loadedCount = vehicle.parcels.filter(p => p.status === 'loaded').length;
                const unloadedCount = vehicle.parcels.filter(p => p.status === 'unloaded').length;
                const destinations = Array.from(vehicle.destinations).join(', ');
                
                html += `
                    <div class="vehicle-card" onclick="showVehicleDetails('${vehicleNo}')">
                        <div class="vehicle-header">
                            <div class="vehicle-number">üöõ ${vehicleNo}</div>
                            <div class="parcel-count">${vehicle.parcels.length} ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</div>
                        </div>
                        <div class="vehicle-destination">
                            üìç ‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø: ${destinations}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <span class="badge badge-loaded">‡¶≤‡ßã‡¶°‡ßá‡¶°: ${loadedCount}</span>
                            <span class="badge badge-unloaded">‡¶Ü‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶°: ${unloadedCount}</span>
                        </div>
                    </div>
                `;
            });
            
            vehiclesList.innerHTML = html;
        }

        function showVehicleDetails(vehicleNo) {
            const vehicleParcels = parcels.filter(p => p.currentVehicle === vehicleNo);
            
            if (vehicleParcels.length === 0) return;
            
            let tableHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <p style="font-size: 0.95em; color: #6c757d;">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤: <strong>${vehicleParcels.length}</strong></p>
                        </div>
                        <button class="btn btn-success btn-sm" onclick="downloadVehicleReport('${vehicleNo}')">
                            üì• PDF ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                    <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                    <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</th>
                                    <th>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                                    <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                    <th>‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            vehicleParcels.forEach(parcel => {
                tableHtml += `
                    <tr>
                        <td><strong>${parcel.id}</strong></td>
                        <td>${parcel.senderName}<br><small>${parcel.senderPhone}</small></td>
                        <td>${parcel.receiverName}<br><small>${parcel.receiverPhone}</small></td>
                        <td>${parcel.destination}</td>
                        <td><span class="badge badge-${parcel.status}">${getStatusText(parcel.status)}</span></td>
                        <td>${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Add movement history for this vehicle
            let historyHtml = '<h4 style="margin-top: 30px; margin-bottom: 15px;">üìç ‡¶è‡¶á ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4>';
            historyHtml += '<div class="history-timeline">';
            
            const allTracking = [];
            vehicleParcels.forEach(parcel => {
                if (parcel.tracking) {
                    parcel.tracking.forEach(track => {
                        if (track.vehicleNo === vehicleNo) {
                            allTracking.push({
                                ...track,
                                parcelId: parcel.id
                            });
                        }
                    });
                }
            });
            
            // Sort by time (newest first)
            allTracking.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (allTracking.length > 0) {
                allTracking.forEach(track => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-action">${track.description}</div>
                            <div class="history-details">üì¶ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤: ${track.parcelId}</div>
                            ${track.location ? `<div class="history-details">üìç ${track.location}</div>` : ''}
                            <div class="history-time">‚è∞ ${track.time}</div>
                            ${track.by ? `<div class="history-time">üë§ ${track.by}</div>` : ''}
                        </div>
                    `;
                });
            } else {
                historyHtml += '<p style="text-align: center; color: #6c757d;">‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</p>';
            }
            
            historyHtml += '</div>';
            
            document.getElementById('vehicleModalTitle').textContent = `üöõ ${vehicleNo} - ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§`;
            document.getElementById('vehicleModalContent').innerHTML = tableHtml + historyHtml;
            document.getElementById('vehicleModal').classList.add('active');
        }

        function closeVehicleModal() {
            document.getElementById('vehicleModal').classList.remove('active');
        }

        function downloadVehicleReport(vehicleNo) {
            const vehicleParcels = parcels.filter(p => p.currentVehicle === vehicleNo);
            
            if (vehicleParcels.length === 0) {
                alert('‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Chishtiya Transport - Vehicle Report', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Vehicle: ${vehicleNo}`, 105, 25, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Total Parcels: ${vehicleParcels.length}`, 20, 35);
            doc.text(`Date: ${new Date().toLocaleDateString('bn-BD')}`, 20, 42);
            
            const loadedCount = vehicleParcels.filter(p => p.status === 'loaded').length;
            const unloadedCount = vehicleParcels.filter(p => p.status === 'unloaded').length;
            
            doc.text(`Loaded: ${loadedCount}`, 20, 49);
            doc.text(`Unloaded: ${unloadedCount}`, 20, 56);
            
            const tableData = vehicleParcels.map(p => [
                p.id,
                p.senderName,
                p.receiverName,
                p.destination,
                getStatusText(p.status),
                p.deliveryCharge + ' Tk'
            ]);
            
            doc.autoTable({
                startY: 65,
                head: [['Parcel ID', 'Sender', 'Receiver', 'Destination', 'Status', 'Charge']],
                body: tableData,
                styles: { fontSize: 8 }
            });
            
            doc.save(`vehicle-${vehicleNo}-report.pdf`);
        }

        // Dashboard update
        function updateDashboard() {
            const total = parcels.length;
            const delivered = parcels.filter(p => p.status === 'delivered').length;
            const pending = parcels.filter(p => p.status === 'pending').length;
            const revenue = parcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            document.getElementById('totalParcels').textContent = total;
            document.getElementById('deliveredParcels').textContent = delivered;
            document.getElementById('pendingParcels').textContent = pending;
            document.getElementById('totalRevenue').textContent = revenue.toLocaleString('bn-BD') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            
            updateChart();
        }

        function updateChart() {
            const statusCounts = {
                'pending': parcels.filter(p => p.status === 'pending').length,
                'loaded': parcels.filter(p => p.status === 'loaded').length,
                'unloaded': parcels.filter(p => p.status === 'unloaded').length,
                'delivered': parcels.filter(p => p.status === 'delivered').length
            };
            
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            if (statusChart) {
                statusChart.destroy();
            }
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç', '‡¶≤‡ßã‡¶°‡ßá‡¶°', '‡¶Ü‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶°', '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts.loaded, statusCounts.unloaded, statusCounts.delivered],
                        backgroundColor: ['#ffc107', '#17a2b8', '#6f42c1', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Generate Report
        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            const filteredParcels = parcels.filter(p => {
                return p.date >= startDate && p.date <= endDate;
            });
            
            currentReportData = filteredParcels;
            
            const total = filteredParcels.length;
            const delivered = filteredParcels.filter(p => p.status === 'delivered').length;
            const revenue = filteredParcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paid = filteredParcels.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            const reportHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</div>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</div>
                        <div class="stat-value">${delivered}</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                        <div class="stat-value">${revenue.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</div>
                        <div class="stat-value">${paid.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                </div>
                
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</th>
                                <th>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                                <th>‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
                                <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredParcels.length > 0 ? filteredParcels.map(p => `
                                <tr>
                                    <td><strong>${p.id}</strong></td>
                                    <td>${p.senderName}</td>
                                    <td>${p.receiverName}</td>
                                    <td>${p.destination}</td>
                                    <td>${p.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                                    <td><span class="badge badge-${p.status}">${getStatusText(p.status)}</span></td>
                                    <td>${p.date}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 30px;">‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportResult').innerHTML = reportHtml;
            document.getElementById('reportButtons').style.display = 'block';
        }

        // Download Report PDF
        function downloadReportPDF() {
            if (!currentReportData) {
                alert('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Chishtiya Transport - Report', 105, 15, { align: 'center' });
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Period: ${startDate} to ${endDate}`, 105, 25, { align: 'center' });
            
            const total = currentReportData.length;
            const delivered = currentReportData.filter(p => p.status === 'delivered').length;
            const revenue = currentReportData.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paid = currentReportData.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            doc.setFontSize(12);
            doc.text(`Total Parcels: ${total}`, 20, 35);
            doc.text(`Delivered: ${delivered}`, 20, 45);
            doc.text(`Total Revenue: ${revenue} Taka`, 20, 55);
            doc.text(`Paid Amount: ${paid} Taka`, 20, 65);
            
            if (currentReportData.length > 0) {
                const tableData = currentReportData.map(p => [
                    p.id,
                    p.senderName,
                    p.receiverName,
                    p.destination,
                    p.deliveryCharge,
                    getStatusText(p.status),
                    p.date
                ]);
                
                doc.autoTable({
                    startY: 75,
                    head: [['ID', 'Sender', 'Receiver', 'Destination', 'Charge', 'Status', 'Date']],
                    body: tableData,
                    styles: { fontSize: 8 }
                });
            }
            
            doc.save(`report-${startDate}-to-${endDate}.pdf`);
        }

        // User Management Functions
        function showAddUserForm() {
            document.getElementById('addUserForm').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('addUserForm').style.display = 'none';
            document.getElementById('newUserUid').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserRole').value = 'scanner';
        }

        async function addUser() {
            const uid = document.getElementById('newUserUid').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!uid || !name || !email) {
                alert('‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            try {
                await window.dbSet(window.dbRef(window.db, 'users/' + uid), {
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                alert('‚úÖ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                hideAddUserForm();
                loadUsers();
            } catch (error) {
                console.error('Error adding user:', error);
                alert('‚ùå ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        async function loadUsers() {
            const usersRef = window.dbRef(window.db, 'users');
            window.dbOnValue(usersRef, (snapshot) => {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = child.val();
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${child.key}', '${user.name}')">
                                    üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                                </button>
                            </td>
                        `;
                    });
                }
            });
        }

        async function deleteUser(uid, name) {
            if (uid === currentUser.uid) {
                alert('‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ');
                return;
            }
            
            if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ${name} ‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                try {
                    await window.dbRemove(window.dbRef(window.db, 'users/' + uid));
                    alert('‚úÖ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('‚ùå ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                }
            }
        }
    </script>
</body>
</html>
