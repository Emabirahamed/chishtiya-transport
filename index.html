<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü - Management System</title>
    
    <!-- Firebase v10 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC2BMeBAU-7tLrBw0dKehAVix6mT9C4lWI",
            authDomain: "chishtiya-transport.firebaseapp.com",
            databaseURL: "https://chishtiya-transport-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chishtiya-transport",
            storageBucket: "chishtiya-transport.firebasestorage.app",
            messagingSenderId: "796543197916",
            appId: "1:796543197916:web:64a0e89d68280986a60a19"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.auth = auth;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.authSignIn = signInWithEmailAndPassword;
        window.authCreateUser = createUserWithEmailAndPassword;
        window.authOnStateChanged = onAuthStateChanged;
        window.authSignOut = signOut;
        window.firebaseReady = true;
        
        console.log('‚úÖ Firebase initialized!');
    </script>
    
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans Bengali', 'SolaimanLipi', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .dot.online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Auth Screens */
        .auth-container {
            max-width: 450px;
            margin: 80px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }
        
        .auth-container.active {
            display: block;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h1 {
            color: #2a5298;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
            width: auto;
        }
        
        .error-message {
            background: #f8d7da;
            color: #842029;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }
        
        .container.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-admin { background: #ffc107; color: #000; }
        .badge-manager { background: #17a2b8; color: white; }
        .badge-scanner { background: #28a745; color: white; }
        .badge-delivery { background: #6f42c1; color: white; }

        /* Navigation */
        .nav {
            background: #f8f9fa;
            padding: 0;
            display: flex;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.05em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            display: none;
        }
        
        .tab.visible {
            display: block;
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #2a5298;
        }
        
        .tab.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        /* Content Area */
        .content {
            padding: 40px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .chart-container h3 {
            color: #2a5298;
            margin-bottom: 20px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #2a5298;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-loaded { background: #cfe2ff; color: #084298; }
        .badge-unloaded { background: #d4edda; color: #155724; }
        .badge-delivered { background: #d1e7dd; color: #0f5132; }
        .badge-paid { background: #d1e7dd; color: #0f5132; }
        .badge-due { background: #f8d7da; color: #842029; }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* QR Scanner */
        #qr-reader {
            max-width: 500px;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .scanner-result {
            background: #d1e7dd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em;
            color: #0f5132;
            display: none;
        }

        /* Print Styles */
        .receipt-container {
            background: white;
            max-width: 800px;
            margin: 0 auto;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            #receiptContent, #receiptContent * {
                visibility: visible;
            }
            
            #receiptContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20mm;
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: A4;
                margin: 0;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2a5298;
        }
        
        .close-modal {
            font-size: 2em;
            cursor: pointer;
            color: #6c757d;
            line-height: 1;
        }
        
        .close-modal:hover {
            color: #dc3545;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .content {
                padding: 20px;
            }
            
            .nav {
                padding: 0;
            }
            
            .tab {
                padding: 15px 20px;
                font-size: 0.95em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .receipt-print {
            padding: 40px;
            max-width: 21cm;
            margin: 0 auto;
            background: white;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2a5298;
            padding-bottom: 20px;
        }
        
        .receipt-qr {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .receipt-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .receipt-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
        }
        
        .receipt-table td:first-child {
            font-weight: 600;
            background: #f8f9fa;
            width: 35%;
        }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div class="status">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container active">
        <div class="auth-header">
            <h1>üöõ ‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
            <p>Management System</p>
        </div>
        
        <div id="loginError" class="error-message"></div>
        
        <form onsubmit="event.preventDefault(); handleLogin();">
            <div class="form-group">
                <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                <input type="email" id="loginEmail" required placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            
            <div class="form-group">
                <label>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                <input type="password" id="loginPassword" required placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            
            <button type="submit" class="btn btn-primary">
                üîê ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </form>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="auth-container">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üöõ ‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
                <p style="opacity: 0.9;">‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</p>
            </div>
            <div class="user-info">
                <div id="currentUserName" style="font-size: 1.1em; margin-bottom: 5px;"></div>
                <div id="currentUserEmail" style="opacity: 0.8; font-size: 0.9em;"></div>
                <button class="btn btn-danger btn-sm" onclick="handleLogout()" style="margin-top: 10px;">
                    üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="tab" id="tab-dashboard" onclick="showTab('dashboard')">üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
            <button class="tab" id="tab-new-parcel" onclick="showTab('new-parcel')">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</button>
            <button class="tab" id="tab-parcel-list" onclick="showTab('parcel-list')">üì¶ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</button>
            <button class="tab" id="tab-scanner" onclick="showTab('scanner')">üì± ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞</button>
            <button class="tab" id="tab-accounts" onclick="showTab('accounts')">üí∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</button>
            <button class="tab" id="tab-reports" onclick="showTab('reports')">üìà ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
            <button class="tab" id="tab-users" onclick="showTab('users')">üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</button>
        </div>

        <!-- Content Area -->
        <div class="content" id="contentArea">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <h2 style="color: #2a5298; margin-bottom: 25px;">üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</div>
                        <div class="stat-value" id="totalParcels">0</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</div>
                        <div class="stat-value" id="deliveredParcels">0</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</div>
                        <div class="stat-value" id="pendingParcels">0</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                        <div class="stat-value" id="totalRevenue">‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</h3>
                    <canvas id="weeklyChart" height="80"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üéØ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®</h3>
                    <canvas id="statusChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header no-print">
                <h2>üìÑ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü</h2>
                <span class="close-modal" onclick="closeModal('receiptModal')">&times;</span>
            </div>
            <div id="receiptContent"></div>
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="printReceipt()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-danger" onclick="closeModal('receiptModal')" style="margin-left: 10px;">‚ùå ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let userRole = null;
        let parcels = [];
        let counter = 1;
        let html5QrCode = null;
        let weeklyChart = null;
        let statusChart = null;

        // Destination list
        const destinations = ['‡¶´‡ßá‡¶®‡ßÄ', '‡¶õ‡¶æ‡¶ó‡¶≤‡¶®‡¶æ‡¶á‡¶Ø‡¶º‡¶æ', '‡¶¨‡¶∏‡ßÅ‡¶∞‡¶π‡¶æ‡¶ü', '‡¶¶‡¶æ‡¶ó‡¶®‡¶≠‡ßÇ‡¶Å‡¶á‡¶Ø‡¶º‡¶æ', '‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¶‡¶™‡ßÅ‡¶∞'];

        // Wait for Firebase
        function waitForFirebase(callback) {
            if (window.firebaseReady) callback();
            else setTimeout(() => waitForFirebase(callback), 100);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            waitForFirebase(() => {
                initAuth();
                initFirebase();
            });
        });

        // Authentication
        function initAuth() {
            window.authOnStateChanged(window.auth, async (user) => {
                if (user) {
                    showLoadingScreen();
                    
                    try {
                        const userRef = window.dbRef(window.db, 'users/' + user.uid);
                        const snapshot = await window.dbGet(userRef);
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                name: userData.name || 'User',
                                role: userData.role || 'scanner'
                            };
                            userRole = currentUser.role;
                            
                            showMainApp();
                        } else {
                            alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                            await window.authSignOut(window.auth);
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                        await window.authSignOut(window.auth);
                    }
                } else {
                    showLoginScreen();
                }
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            
            try {
                await window.authSignIn(window.auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                let message = '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§';
                
                if (error.code === 'auth/invalid-credential') {
                    message = '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!';
                } else if (error.code === 'auth/user-not-found') {
                    message = '‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!';
                } else if (error.code === 'auth/wrong-password') {
                    message = '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!';
                } else if (error.code === 'auth/too-many-requests') {
                    message = '‡¶Ö‡¶®‡ßá‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶≠‡ßÅ‡¶≤ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                }
                
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleLogout() {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                try {
                    if (html5QrCode) stopScanning();
                    await window.authSignOut(window.auth);
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                }
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            currentUser = null;
            userRole = null;
        }

        function showLoadingScreen() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('loadingScreen').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            
            document.getElementById('currentUserName').innerHTML = currentUser.name + 
                ' <span class="user-badge badge-' + userRole + '">' + getRoleDisplayName(userRole) + '</span>';
            document.getElementById('currentUserEmail').textContent = currentUser.email;
            
            setupUIForRole(userRole);
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®',
                'manager': '‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞',
                'scanner': '‡¶≤‡ßá‡¶¨‡¶æ‡¶∞',
                'delivery': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶¨‡¶Ø‡¶º'
            };
            return roleNames[role] || '‡¶á‡¶â‡¶ú‡¶æ‡¶∞';
        }

        function setupUIForRole(role) {
            const tabs = {
                'admin': ['dashboard', 'new-parcel', 'parcel-list', 'scanner', 'accounts', 'reports', 'users'],
                'manager': ['dashboard', 'new-parcel', 'parcel-list', 'scanner', 'accounts', 'reports'],
                'scanner': ['scanner'],
                'delivery': ['scanner']
            };

            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('visible', 'active');
                t.style.display = 'none';
            });

            (tabs[role] || []).forEach(tabName => {
                const tab = document.getElementById('tab-' + tabName);
                if (tab) {
                    tab.classList.add('visible');
                    tab.style.display = 'block';
                }
            });

            loadAllTabs();
            
            if (role === 'admin' || role === 'manager') {
                showTab('dashboard');
            } else {
                showTab('scanner');
            }
        }

        function initFirebase() {
            const connRef = window.dbRef(window.db, '.info/connected');
            window.dbOnValue(connRef, (snap) => {
                const online = snap.val() === true;
                document.getElementById('statusDot').className = online ? 'dot online' : 'dot';
                document.getElementById('statusText').textContent = online ? '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®' : '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®';
            });

            const counterRef = window.dbRef(window.db, 'counter');
            window.dbOnValue(counterRef, (snap) => {
                if (snap.exists()) {
                    counter = snap.val();
                    console.log('Counter loaded:', counter);
                }
            });

            const parcelsRef = window.dbRef(window.db, 'parcels');
            window.dbOnValue(parcelsRef, (snap) => {
                parcels = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        parcels.push({ key: child.key, ...child.val() });
                    });
                }
                console.log('Parcels loaded:', parcels.length);
                
                if (userRole === 'admin' || userRole === 'manager') {
                    updateDashboard();
                    updateParcelList();
                    updateReports();
                    updateAccounts();
                }
            });
        }

        function loadAllTabs() {
            const contentArea = document.getElementById('contentArea');
            
            // New Parcel Tab
            const newParcelTab = document.createElement('div');
            newParcelTab.id = 'new-parcel';
            newParcelTab.className = 'tab-content';
            newParcelTab.innerHTML = `
                <h2 style="color: #2a5298; margin-bottom: 25px;">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
                
                <form onsubmit="event.preventDefault(); addParcel();">
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
                            <input type="text" id="senderName" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® *</label>
                            <input type="tel" id="senderPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
                            <input type="text" id="receiverName" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® *</label>
                            <input type="tel" id="receiverPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø/‡¶Æ‡ßã‡¶ï‡¶æ‡¶Æ *</label>
                            <select id="destination" required>
                                <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                ${destinations.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)</label>
                            <input type="number" id="weight" step="0.1" placeholder="‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú (‡¶ü‡¶æ‡¶ï‡¶æ) *</label>
                            <input type="number" id="deliveryCharge" required>
                        </div>
                        <div class="form-group">
                            <label>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ *</label>
                            <select id="paymentStatus" required>
                                <option value="due">‡¶¨‡¶æ‡¶ï‡¶ø</option>
                                <option value="paid">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                        <textarea id="description" rows="3" placeholder="‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </form>
            `;
            contentArea.appendChild(newParcelTab);

            // Parcel List Tab
            const parcelListTab = document.createElement('div');
            parcelListTab.id = 'parcel-list';
            parcelListTab.className = 'tab-content';
            parcelListTab.innerHTML = `
                <h2 style="color: #2a5298; margin-bottom: 25px;">üì¶ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchParcel" placeholder="‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø, ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." 
                           onkeyup="filterParcels()" style="max-width: 400px;">
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</th>
                                <th>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                                <th>‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
                                <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                <th>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="parcelTableBody"></tbody>
                    </table>
                </div>
            `;
            contentArea.appendChild(parcelListTab);

            // Scanner Tab
            const scannerTab = document.createElement('div');
            scannerTab.id = 'scanner';
            scannerTab.className = 'tab-content';
            scannerTab.innerHTML = `
                <h2 style="color: #2a5298; margin-bottom: 25px; text-align: center;">
                    ${userRole === 'delivery' ? 'üèçÔ∏è ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'üì± ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'}
                </h2>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="startScanning()">üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button class="btn btn-danger" onclick="stopScanning()" style="margin-left: 10px;">‚èπÔ∏è ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                
                <div id="qr-reader"></div>
                <div id="scannerResult" class="scanner-result"></div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <h3>‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
                    <input type="text" id="manualParcelId" placeholder="‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" 
                           style="max-width: 300px; margin: 15px 0;">
                    <br>
                    <button class="btn btn-success" onclick="processManualScan()">‚úÖ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            `;
            contentArea.appendChild(scannerTab);

            <div id="scanner" class="tab-content">
    <h2 style="margin-bottom: 25px; color: #2a5298;">üì∑ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
    
    <!-- Vehicle Selection - ‡¶®‡¶§‡ßÅ‡¶® -->
    <div class="form-group" style="max-width: 600px; margin: 0 auto 30px;">
        <label>‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® *</label>
        <select id="scannerVehicle" style="font-size: 1.1em; padding: 15px;" required>
            <option value="">‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ó-‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ó-‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ò-‡ß≠‡ßÆ-‡ßØ‡ß¶‡ßß‡ß®">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ò-‡ß≠‡ßÆ-‡ßØ‡ß¶‡ßß‡ß®</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ö-‡ß©‡ß™-‡ß´‡ß¨‡ß≠‡ßÆ">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ö-‡ß©‡ß™-‡ß´‡ß¨‡ß≠‡ßÆ</option>
        </select>
    </div>
    
    <!-- QR Scanner -->
    <div class="scanner-container">
        <div id="reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn btn-primary" onclick="startScanning()" id="startScanBtn">
                üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
            <button class="btn btn-danger hidden" onclick="stopScanning()" id="stopScanBtn">
                ‚èπÔ∏è ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
        
        <!-- Manual Entry -->
        <div style="max-width: 400px; margin: 20px auto;">
            <div class="form-group">
                <label>‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                <input type="text" id="manualParcelId" placeholder="CT000001" 
                       style="text-transform: uppercase;">
            </div>
            <button class="btn btn-success" onclick="processManualScan()" style="width: 100%;">
                ‚úÖ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
        
        <div id="scannerResult" style="display: none;"></div>
    </div>
</div>
            // Vehicle Report Tab
            <div id="vehicle-report" class="tab-content">
    <h2 style="margin-bottom: 25px; color: #2a5298;">üöó ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
    
    <!-- Vehicle Selector -->
    <div class="form-group" style="max-width: 400px; margin-bottom: 30px;">
        <label>‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select id="reportVehicleSelect" onchange="loadVehicleReport()" 
                style="font-size: 1.1em; padding: 12px;">
            <option value="">‡¶∏‡¶¨ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ó-‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ó-‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ò-‡ß≠‡ßÆ-‡ßØ‡ß¶‡ßß‡ß®">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ò-‡ß≠‡ßÆ-‡ßØ‡ß¶‡ßß‡ß®</option>
            <option value="‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ö-‡ß©‡ß™-‡ß´‡ß¨‡ß≠‡ßÆ">‡¶¢‡¶æ‡¶ï‡¶æ-‡¶Æ‡ßá‡¶ü‡ßç‡¶∞‡ßã-‡¶ö-‡ß©‡ß™-‡ß´‡ß¨‡ß≠‡ßÆ</option>
        </select>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid" id="vehicleStatsGrid">
        <div class="stat-card">
            <h3 id="vehicleTotalParcels">0</h3>
            <p>‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h3 id="vehicleLoadedParcels">0</h3>
            <p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h3 id="vehicleDeliveredParcels">0</h3>
            <p>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h3 id="vehicleRevenue">‡ß¶</h3>
            <p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º (‡¶ü‡¶æ‡¶ï‡¶æ)</p>
        </div>
    </div>
    
    <!-- Parcel List -->
    <h3 style="margin: 30px 0 15px; color: #2a5298;">‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
    <div id="vehicleParcelList"></div>
    
    <!-- Export Button -->
    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="exportVehicleReport()">
            üìÑ PDF ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>
</div>
function loadVehicleReport() {
    const selectedVehicle = document.getElementById('reportVehicleSelect').value;
    
    let filteredParcels = parcels;
    if (selectedVehicle) {
        filteredParcels = parcels.filter(p => p.currentVehicle === selectedVehicle);
    }
    
    // Stats
    const total = filteredParcels.length;
    const loaded = filteredParcels.filter(p => p.status === 'loaded').length;
    const delivered = filteredParcels.filter(p => p.status === 'delivered').length;
    const revenue = filteredParcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
    
    document.getElementById('vehicleTotalParcels').textContent = total;
    document.getElementById('vehicleLoadedParcels').textContent = loaded;
    document.getElementById('vehicleDeliveredParcels').textContent = delivered;
    document.getElementById('vehicleRevenue').textContent = revenue.toLocaleString('bn-BD');
    
    // Parcel List
    const listDiv = document.getElementById('vehicleParcelList');
    if (filteredParcels.length === 0) {
        listDiv.innerHTML = '<div class="no-data">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á</div>';
        return;
    }
    
    let html = '<table style="width: 100%; border-collapse: collapse;">';
    html += `
        <thead>
            <tr style="background: #2a5298; color: white;">
                <th style="padding: 12px; text-align: left;">‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                <th style="padding: 12px; text-align: left;">‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                <th style="padding: 12px; text-align: left;">‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                <th style="padding: 12px; text-align: left;">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                <th style="padding: 12px; text-align: right;">‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    filteredParcels.forEach((p, index) => {
        const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
        const statusText = getStatusText(p.status);
        html += `
            <tr style="background: ${bgColor};">
                <td style="padding: 10px;"><strong>${p.id}</strong></td>
                <td style="padding: 10px;">${p.senderName}</td>
                <td style="padding: 10px;">${p.destination}</td>
                <td style="padding: 10px;">${statusText}</td>
                <td style="padding: 10px; text-align: right;">${p.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

function getStatusText(status) {
    const statusMap = {
        'pending': '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç',
        'loaded': '‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá',
        'unloaded': '‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã',
        'delivered': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°'
    };
    return statusMap[status] || status;
}
            // vehicle-report tab
            <div class="tabs">
    <button class="tab visible active" id="tab-dashboard" onclick="showTab('dashboard')">
        üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
    </button>
    <button class="tab visible" id="tab-new-parcel" onclick="showTab('new-parcel')">
        üì¶ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤
    </button>
    <button class="tab visible" id="tab-scanner" onclick="showTab('scanner')">
        üì∑ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®
    </button>
    <button class="tab visible" id="tab-parcel-list" onclick="showTab('parcel-list')">
        üìã ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
    </button>
    <button class="tab visible" id="tab-vehicle-report" onclick="showTab('vehicle-report')">
        üöó ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
    </button>
    <button class="tab visible" id="tab-accounts" onclick="showTab('accounts')">
        üí∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
    </button>
</div>
            // Accounts Tab
            const accountsTab = document.createElement('div');
            accountsTab.id = 'accounts';
            accountsTab.className = 'tab-content';
            accountsTab.innerHTML = `
                <h2 style="color: #2a5298; margin-bottom: 25px;">üí∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="downloadAccountsPDF()">üì• PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                        <div class="stat-value" id="accountTotalRevenue">‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</div>
                        <div class="stat-value" id="accountPaidAmount">‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">‡¶¨‡¶æ‡¶ï‡¶ø</div>
                        <div class="stat-value" id="accountDueAmount">‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                </div>
                
                <div class="table-container" style="margin-top: 30px;">
                    <h3 style="padding: 15px; background: #f8f9fa; margin: 0; color: #2a5298;">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                <th>‡¶´‡ßã‡¶®</th>
                                <th>‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="dueParcelsList"></tbody>
                    </table>
                </div>
            `;
            contentArea.appendChild(accountsTab);

            // Reports Tab
            const reportsTab = document.createElement('div');
            reportsTab.id = 'reports';
            reportsTab.className = 'tab-content';
            reportsTab.innerHTML = `
                <h2 style="color: #2a5298; margin-bottom: 25px;">üìà ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="generateReport()">üîç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                    </div>
                </div>
                
                <div id="reportButtons" style="margin: 20px 0; display: none;">
                    <button class="btn btn-success" onclick="downloadReportPDF()">üì• PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                
                <div id="reportResult" style="margin-top: 30px;"></div>
            `;
            contentArea.appendChild(reportsTab);

            // Users Tab (Admin only)
            if (userRole === 'admin') {
                const usersTab = document.createElement('div');
                usersTab.id = 'users';
                usersTab.className = 'tab-content';
                usersTab.innerHTML = `
                    <h2 style="color: #2a5298; margin-bottom: 25px;">üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ:</strong> ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Firebase Console ‡¶è ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®,
                        ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                    </div>
                    
                    <button class="btn btn-primary" onclick="showAddUserForm()" style="margin-bottom: 20px;">
                        ‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    
                    <div id="addUserForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>UID (Firebase ‡¶•‡ßá‡¶ï‡ßá)</label>
                                <input type="text" id="newUserUid" required>
                            </div>
                            <div class="form-group">
                                <label>‡¶®‡¶æ‡¶Æ</label>
                                <input type="text" id="newUserName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                                <input type="email" id="newUserEmail" required>
                            </div>
                            <div class="form-group">
                                <label>‡¶∞‡ßã‡¶≤</label>
                                <select id="newUserRole" required>
                                    <option value="scanner">‡¶≤‡ßá‡¶¨‡¶æ‡¶∞</option>
                                    <option value="delivery">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶¨‡¶Ø‡¶º</option>
                                    <option value="manager">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞</option>
                                    <option value="admin">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addUser()">‚úÖ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <button class="btn btn-danger" onclick="hideAddUserForm()" style="margin-left: 10px;">‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>‡¶®‡¶æ‡¶Æ</th>
                                    <th>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                                    <th>‡¶∞‡ßã‡¶≤</th>
                                    <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                `;
                contentArea.appendChild(usersTab);
                
                loadUsers();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            const tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            
            const btn = document.getElementById('tab-' + tabName);
            if (btn) btn.classList.add('active');
        }

        // Dashboard Functions
        function updateDashboard() {
            const total = parcels.length;
            const delivered = parcels.filter(p => p.status === 'delivered').length;
            const pending = parcels.filter(p => p.status === 'pending').length;
            const revenue = parcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            document.getElementById('totalParcels').textContent = total;
            document.getElementById('deliveredParcels').textContent = delivered;
            document.getElementById('pendingParcels').textContent = pending;
            document.getElementById('totalRevenue').textContent = revenue.toLocaleString('bn-BD') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            
            updateCharts();
        }

        function updateCharts() {
            // Weekly Chart
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyCounts = last7Days.map(date => {
                return parcels.filter(p => p.date === date).length;
            });
            
            const ctx1 = document.getElementById('weeklyChart');
            if (ctx1) {
                if (weeklyChart) weeklyChart.destroy();
                weeklyChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => new Date(d).toLocaleDateString('bn-BD')),
                        datasets: [{
                            label: '‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ',
                            data: dailyCounts,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // Status Chart
            const statusCounts = {
                pending: parcels.filter(p => p.status === 'pending').length,
                loaded: parcels.filter(p => p.status === 'loaded').length,
                unloaded: parcels.filter(p => p.status === 'unloaded').length,
                delivered: parcels.filter(p => p.status === 'delivered').length
            };
            
            const ctx2 = document.getElementById('statusChart');
            if (ctx2) {
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç', '‡¶≤‡ßã‡¶°‡ßá‡¶°', '‡¶Ü‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶°', '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°'],
                        datasets: [{
                            data: [statusCounts.pending, statusCounts.loaded, statusCounts.unloaded, statusCounts.delivered],
                            backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#20c997']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }
        }

        // Add Parcel Function
        async function addParcel() {
            try {
                const parcelId = 'CT' + String(counter).padStart(6, '0');
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const time = now.toLocaleTimeString('bn-BD');
                
                const parcelData = {
                    id: parcelId,
                    senderName: document.getElementById('senderName').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    destination: document.getElementById('destination').value,
                    weight: document.getElementById('weight').value || '',
                    deliveryCharge: document.getElementById('deliveryCharge').value,
                    paymentStatus: document.getElementById('paymentStatus').value,
                    description: document.getElementById('description').value || '',
                    status: 'pending',
                    date: date,
                    time: time,
                    createdBy: currentUser.name,
                    currentLocation: '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏',
                    tracking: [{
                        type: 'created',
                        description: '‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
                        location: '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶´‡¶ø‡¶∏',
                        time: date + ' ' + time,
                        by: currentUser.name
                    }]
                };
                
                const newParcelRef = window.dbPush(window.dbRef(window.db, 'parcels'));
                await window.dbSet(newParcelRef, parcelData);
                
                await window.dbSet(window.dbRef(window.db, 'counter'), counter + 1);
                
                alert('‚úÖ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø: ' + parcelId);
                
                document.querySelector('#new-parcel form').reset();
                
                showReceipt(parcelData);
            } catch (error) {
                console.error('Error adding parcel:', error);
                alert('‚ùå ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        // Show Receipt
        function showReceipt(parcel) {
            const receiptContent = `
                <div class="receipt-print">
                    <div class="receipt-header">
                        <h1 style="color: #2a5298; margin-bottom: 10px;">‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
                        <p style="font-size: 1.2em;">‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü</p>
                    </div>
                    
                    <div class="receipt-qr">
                        <div id="parcelQR" style="display: inline-block;"></div>
                        <p style="margin-top: 15px; font-weight: bold; font-size: 1.3em;">${parcel.id}</p>
                    </div>
                    
                    <table class="receipt-table">
                        <tr>
                            <td>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</td>
                            <td>${parcel.senderName}</td>
                        </tr>
                        <tr>
                            <td>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶®</td>
                            <td>${parcel.senderPhone}</td>
                        </tr>
                        <tr>
                            <td>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</td>
                            <td>${parcel.receiverName}</td>
                        </tr>
                        <tr>
                            <td>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶®</td>
                            <td>${parcel.receiverPhone}</td>
                        </tr>
                        <tr>
                            <td>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</td>
                            <td>${parcel.destination}</td>
                        </tr>
                        ${parcel.weight ? `
                        <tr>
                            <td>‡¶ì‡¶ú‡¶®</td>
                            <td>${parcel.weight} ‡¶ï‡ßá‡¶ú‡¶ø</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</td>
                            <td style="font-weight: bold; font-size: 1.1em;">${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                        </tr>
                        <tr>
                            <td>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</td>
                            <td>${parcel.paymentStatus === 'paid' ? '‚úÖ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§' : '‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø'}</td>
                        </tr>
                        <tr>
                            <td>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡¶Ø‡¶º</td>
                            <td>${parcel.date} ${parcel.time}</td>
                        </tr>
                    </table>
                    
                    ${parcel.description ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</strong> ${parcel.description}
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #dee2e6; text-align: center; font-size: 0.9em; color: #6c757d;">
                        <p>‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßÅ‡¶®: track.html ‡¶™‡ßá‡¶ú‡ßá ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>
                        <p style="margin-top: 10px;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ - ‡¶ö‡¶ø‡¶∂‡¶§‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</p>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptContent;
            document.getElementById('receiptModal').classList.add('active');
            
            // Generate QR Code
            setTimeout(() => {
                const qrDiv = document.getElementById('parcelQR');
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, {
                    text: parcel.id,
                    width: 150,
                    height: 150
                });
            }, 100);
        }

        function printReceipt() {
            window.print();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Update Parcel List
        function updateParcelList() {
            const tbody = document.getElementById('parcelTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (parcels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #6c757d;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</td></tr>';
                return;
            }
            
            const sortedParcels = [...parcels].reverse();
            
            sortedParcels.forEach(parcel => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${parcel.id}</strong></td>
                    <td>${parcel.senderName}<br><small>${parcel.senderPhone}</small></td>
                    <td>${parcel.receiverName}<br><small>${parcel.receiverPhone}</small></td>
                    <td>${parcel.destination}</td>
                    <td>${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                    <td><span class="badge badge-${parcel.status}">${getStatusText(parcel.status)}</span></td>
                    <td><span class="badge badge-${parcel.paymentStatus === 'paid' ? 'paid' : 'due'}">${parcel.paymentStatus === 'paid' ? '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§' : '‡¶¨‡¶æ‡¶ï‡¶ø'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewParcelDetails('${parcel.key}')">üëÅÔ∏è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                        </div>
                    </td>
                `;
            });
        }

        function getStatusText(status) {
            const texts = {
                'pending': '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç',
                'loaded': '‡¶≤‡ßã‡¶°‡ßá‡¶°',
                'unloaded': '‡¶Ü‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶°',
                'delivered': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°'
            };
            return texts[status] || '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç';
        }

        function filterParcels() {
            const searchTerm = document.getElementById('searchParcel').value.toLowerCase();
            const rows = document.querySelectorAll('#parcelTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function viewParcelDetails(key) {
            const parcel = parcels.find(p => p.key === key);
            if (!parcel) return;
            
            showReceipt(parcel);
        }

        // Scanner Functions
        function startScanning() {
            const qrReader = document.getElementById('qr-reader');
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error('Camera error:', err);
                alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            });
        }

        function stopScanning() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log('Scanner stopped');
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                });
            }
        }

        function onScanSuccess(decodedText) {
            processScannedParcel(decodedText);
        }

        function onScanError(error) {
            // Ignore scan errors (common when scanning)
        }

        function processManualScan() {
            const parcelId = document.getElementById('manualParcelId').value.trim().toUpperCase();
            if (parcelId) {
                processScannedParcel(parcelId);
            } else {
                alert('‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
            }
        }

        async function processScannedParcel(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            
            if (!parcel) {
                alert('‚ùå ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø: ' + parcelId);
                return;
            }
            const vehicleNumber = document.getElementById('scannerVehicle')?.value || 'N/A';
    
    let newStatus;
    let description;
    let location;
    
    if (userRole === 'delivery') {
        newStatus = 'delivered';
        description = '‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
        location = parcel.destination;
    } else if (userRole === 'scanner') {
        if (parcel.status === 'pending') {
            newStatus = 'loaded';
            description = '‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶§‡ßã‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
            location = '‡¶¢‡¶æ‡¶ï‡¶æ';
        } else if (parcel.status === 'loaded') {
            newStatus = 'unloaded';
            description = '‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø‡ßá ‡¶™‡ßå‡¶Å‡¶õ‡ßá‡¶õ‡ßá';
            location = parcel.destination;
        } else {
            alert('‡¶è‡¶á ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            return;
        }
    }
    
    try {
        const now = new Date();
        const trackingEntry = {
            type: newStatus,
            description: description,
            location: location,
            vehicleNumber: vehicleNumber,  // ‡¶®‡¶§‡ßÅ‡¶®
            time: now.toISOString().split('T')[0] + ' ' + now.toLocaleTimeString('bn-BD'),
            by: currentUser.name,
            timestamp: now.getTime()  // ‡¶®‡¶§‡ßÅ‡¶® - sorting ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        };
        
        // CRITICAL FIX: Read first, then update
        const parcelRef = window.dbRef(window.db, 'parcels/' + parcel.key);
        const currentSnapshot = await window.dbGet(parcelRef);
        
        if (!currentSnapshot.exists()) {
            alert('‚ùå ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!');
            console.error('Parcel not found in database:', parcel.key);
            return;
        }
        
        const currentData = currentSnapshot.val();
        const currentTracking = currentData.tracking || [];
        
        // Safe update - ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º fields
        const updates = {
            status: newStatus,
            currentLocation: location,
            currentVehicle: vehicleNumber,  // ‡¶®‡¶§‡ßÅ‡¶®
            tracking: [...currentTracking, trackingEntry],  // Append, not replace
            lastUpdated: now.getTime()  // ‡¶®‡¶§‡ßÅ‡¶®
        };
        
        // Atomic update
        await window.dbUpdate(parcelRef, updates);
        
        // Success message
        const resultDiv = document.getElementById('scannerResult');
        resultDiv.innerHTML = `
            ‚úÖ ‡¶∏‡¶´‡¶≤!<br>
            ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤: ${parcelId}<br>
            ${description}<br>
            ‡¶ó‡¶æ‡¶°‡¶º‡¶ø: ${vehicleNumber}
        `;
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d1e7dd';
        resultDiv.style.color = '#0f5132';
        resultDiv.style.padding = '15px';
        resultDiv.style.borderRadius = '8px';
        resultDiv.style.marginTop = '15px';
        
        document.getElementById('manualParcelId').value = '';
        
        // Log for debugging
        console.log('‚úÖ Parcel updated successfully:', {
            id: parcelId,
            status: newStatus,
            vehicle: vehicleNumber,
            key: parcel.key
        });
        
        setTimeout(() => {
            resultDiv.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('‚ùå Error updating parcel:', error);
        alert('‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message);
        
        // Error log ‡¶ï‡¶∞‡ßÅ‡¶® debugging ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        const errorLog = {
            parcelId: parcelId,
            error: error.message,
            time: new Date().toISOString(),
            user: currentUser.name
        };
        console.error('Error Log:', errorLog);
    }
}
            
            let newStatus;
            let description;
            let location;
            
            if (userRole === 'delivery') {
                newStatus = 'delivered';
                description = '‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
                location = parcel.destination;
            } else if (userRole === 'scanner') {
                if (parcel.status === 'pending') {
                    newStatus = 'loaded';
                    description = '‡¶ó‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶§‡ßã‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
                    location = '‡¶¢‡¶æ‡¶ï‡¶æ';
                } else if (parcel.status === 'loaded') {
                    newStatus = 'unloaded';
                    description = '‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø‡ßá ‡¶™‡ßå‡¶Å‡¶õ‡ßá‡¶õ‡ßá';
                    location = parcel.destination;
                } else {
                    alert('‡¶è‡¶á ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                    return;
                }
            }
            
            try {
                const now = new Date();
                const trackingEntry = {
                    type: newStatus,
                    description: description,
                    location: location,
                    time: now.toISOString().split('T')[0] + ' ' + now.toLocaleTimeString('bn-BD'),
                    by: currentUser.name
                };
                
                const updates = {
                    status: newStatus,
                    currentLocation: location,
                    tracking: [...(parcel.tracking || []), trackingEntry]
                };
                
                await window.dbUpdate(window.dbRef(window.db, 'parcels/' + parcel.key), updates);
                
                const resultDiv = document.getElementById('scannerResult');
                resultDiv.innerHTML = `‚úÖ ‡¶∏‡¶´‡¶≤!<br>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤: ${parcelId}<br>${description}`;
                resultDiv.style.display = 'block';
                
                document.getElementById('manualParcelId').value = '';
                
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error updating parcel:', error);
                alert('‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        // Accounts Functions
        function updateAccounts() {
            const totalRevenue = parcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paidAmount = parcels.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const dueAmount = totalRevenue - paidAmount;
            
            document.getElementById('accountTotalRevenue').textContent = totalRevenue.toLocaleString('bn-BD') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            document.getElementById('accountPaidAmount').textContent = paidAmount.toLocaleString('bn-BD') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            document.getElementById('accountDueAmount').textContent = dueAmount.toLocaleString('bn-BD') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            
            const tbody = document.getElementById('dueParcelsList');
            if (tbody) {
                tbody.innerHTML = '';
                
                const dueParcels = parcels.filter(p => p.paymentStatus === 'due');
                
                if (dueParcels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á</td></tr>';
                } else {
                    dueParcels.forEach(parcel => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><strong>${parcel.id}</strong></td>
                            <td>${parcel.senderName}</td>
                            <td>${parcel.senderPhone}</td>
                            <td>${parcel.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                            <td>${parcel.date}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="markAsPaid('${parcel.key}')">
                                    ‚úÖ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                            </td>
                        `;
                    });
                }
            }
        }

        async function markAsPaid(key) {
            if (confirm('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) {
                try {
                    await window.dbUpdate(window.dbRef(window.db, 'parcels/' + key), {
                        paymentStatus: 'paid'
                    });
                    alert('‚úÖ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                } catch (error) {
                    console.error('Error updating payment:', error);
                    alert('‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                }
            }
        }

        // Download Accounts PDF
        function downloadAccountsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Chishtiya Transport - Accounts Report', 105, 15, { align: 'center' });
            
            const totalRevenue = parcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paidAmount = parcels.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const dueAmount = totalRevenue - paidAmount;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Revenue: ${totalRevenue} Taka`, 20, 30);
            doc.text(`Paid Amount: ${paidAmount} Taka`, 20, 40);
            doc.text(`Due Amount: ${dueAmount} Taka`, 20, 50);
            
            const dueParcels = parcels.filter(p => p.paymentStatus === 'due');
            
            if (dueParcels.length > 0) {
                const tableData = dueParcels.map(p => [
                    p.id,
                    p.senderName,
                    p.senderPhone,
                    p.deliveryCharge + ' Taka',
                    p.date
                ]);
                
                doc.autoTable({
                    startY: 60,
                    head: [['Parcel ID', 'Sender', 'Phone', 'Amount', 'Date']],
                    body: tableData
                });
            }
            
            doc.save('accounts-report.pdf');
        }

        // Reports Functions
        function updateReports() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
        }

        let currentReportData = null;

        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            const filteredParcels = parcels.filter(p => {
                return p.date >= startDate && p.date <= endDate;
            });
            
            currentReportData = filteredParcels;
            
            const total = filteredParcels.length;
            const delivered = filteredParcels.filter(p => p.status === 'delivered').length;
            const revenue = filteredParcels.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paid = filteredParcels.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            const reportHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤</div>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶°</div>
                        <div class="stat-value">${delivered}</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                        <div class="stat-value">${revenue.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</div>
                        <div class="stat-value">${paid.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                    </div>
                </div>
                
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï</th>
                                <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</th>
                                <th>‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                                <th>‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</th>
                                <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredParcels.length > 0 ? filteredParcels.map(p => `
                                <tr>
                                    <td><strong>${p.id}</strong></td>
                                    <td>${p.senderName}</td>
                                    <td>${p.receiverName}</td>
                                    <td>${p.destination}</td>
                                    <td>${p.deliveryCharge} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
                                    <td><span class="badge badge-${p.status}">${getStatusText(p.status)}</span></td>
                                    <td>${p.date}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 30px;">‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡ßá‡¶á</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportResult').innerHTML = reportHtml;
            document.getElementById('reportButtons').style.display = 'block';
        }

        // Download Report PDF
        function downloadReportPDF() {
            if (!currentReportData) {
                alert('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Chishtiya Transport - Report', 105, 15, { align: 'center' });
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Period: ${startDate} to ${endDate}`, 105, 25, { align: 'center' });
            
            const total = currentReportData.length;
            const delivered = currentReportData.filter(p => p.status === 'delivered').length;
            const revenue = currentReportData.reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            const paid = currentReportData.filter(p => p.paymentStatus === 'paid')
                .reduce((sum, p) => sum + (parseInt(p.deliveryCharge) || 0), 0);
            
            doc.setFontSize(12);
            doc.text(`Total Parcels: ${total}`, 20, 35);
            doc.text(`Delivered: ${delivered}`, 20, 45);
            doc.text(`Total Revenue: ${revenue} Taka`, 20, 55);
            doc.text(`Paid Amount: ${paid} Taka`, 20, 65);
            
            if (currentReportData.length > 0) {
                const tableData = currentReportData.map(p => [
                    p.id,
                    p.senderName,
                    p.receiverName,
                    p.destination,
                    p.deliveryCharge,
                    getStatusText(p.status),
                    p.date
                ]);
                
                doc.autoTable({
                    startY: 75,
                    head: [['ID', 'Sender', 'Receiver', 'Destination', 'Charge', 'Status', 'Date']],
                    body: tableData,
                    styles: { fontSize: 8 }
                });
            }
            
            doc.save(`report-${startDate}-to-${endDate}.pdf`);
        }

        // User Management Functions
        function showAddUserForm() {
            document.getElementById('addUserForm').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('addUserForm').style.display = 'none';
            document.getElementById('newUserUid').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserRole').value = 'scanner';
        }

        async function addUser() {
            const uid = document.getElementById('newUserUid').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!uid || !name || !email) {
                alert('‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            try {
                await window.dbSet(window.dbRef(window.db, 'users/' + uid), {
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                alert('‚úÖ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                hideAddUserForm();
                loadUsers();
            } catch (error) {
                console.error('Error adding user:', error);
                alert('‚ùå ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        async function loadUsers() {
            const usersRef = window.dbRef(window.db, 'users');
            window.dbOnValue(usersRef, (snapshot) => {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = child.val();
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${child.key}', '${user.name}')">
                                    üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                                </button>
                            </td>
                        `;
                    });
                }
            });
        }

        async function deleteUser(uid, name) {
            if (uid === currentUser.uid) {
                alert('‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ');
                return;
            }
            
            if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ${name} ‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                try {
                    await window.dbRemove(window.dbRef(window.db, 'users/' + uid));
                    alert('‚úÖ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('‚ùå ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                }
            }
        }
    </script>
</body>
</html>
